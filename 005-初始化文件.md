```shell
sudo yum install -y conntrack ntpdate ntp ipvsadm ipset jq iptabls curl sysstat libseccomp vim wget net-tools git -y
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF
#设置系统时区为 服务器所在时区
sudo timedatectl set-timezone Asia/Tokyo
#将当前的UTC时间写入硬件时钟
sudo timedatectl set-local-rtc 0
#重启依赖于系统时间的服务
sudo systemctl restart rsyslog
sudo systemctl restart crond
#关闭系统不需要的服务
#postfix 邮件服务
sudo systemctl stop postfix
sudo systemctl disable postfix
sudo mkdir /var/log/journal
sudo mkdir /etc/systemd/journald.conf.d
cat <<EOF |sudo tee /etc/systemd/journald.conf.d/99-prophet.conf
[Journal]
# 持久化保存到磁盘
Storage =persistent
# 压缩历史日志
Compress=yes

SuncIntervalSec=5m
RateLimitInterval=30s
RateLimitBurst=1000

# 最大占用空间sudo systemctl restart docker
SystemMaxUse=10G

# 单个日志文件最大体积 200M
SystemMaxFileSize=200M

# 日志保存时间 2周
MaxRetentionSec=2week

# 不将日志转发到syslog
ForwardToSyslog=nosudo mkdir /etc/docker
cat <<EOF | sudo tee /etc/docker/daemon.json
{
"exec-opts": ["native.cgroupdriver=systemd"],
"log-driver": "json-file",
"log-opts": {
 "max-size": "100m"
},
"storage-driver": "overlay2"
}
EOF
EOF
sudo systemctl restart systemd-journald
sudo yum install -y yum-utils

sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo setenforce 0
sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
sudo swapoff -a 
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf  
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1sudo grubby \
--update-kernel=ALL \
--args="systemd.unified_cgroup_hierarchy=1"
net.ipv6.conf.all.disable_ipv6=1    
net.ipv4.ip_forward=1    
net.ipv4.tcp_tw_recycle=0    
net.netfilter.nf_conntrack_max=2310720    
vm.swappiness=0 # 禁止使用swap空间，只有当系统oom时才允许启用    
vm.overcommit_memory=1 #不检查物理内存是否够用    
vm.panic_on_oom=0 # 开启OOM    
fs.inotify-max_user_instances=8192   
fs.inotify.max_user_watches=1048576   
fs.file-max=52706963    
fs.nr_open=52706963
EOF
cat <<EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF

# 手动开启允许检查桥接流量
sudo modprobe overlay
sudo modprobe br_netfilter 
sudo sysctl --system
sudo yum install docker-ce docker-ce-cli containerd.io -y 
sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes
sudo systemctl enable --now docker 
sudo systemctl enable --now kubelet
sudo grubby --update-kernel=ALL --args="systemd.unified_cgroup_hierarchy=1"
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
sudo vim /etc/containerd/config.toml
```

第二段

```
sudo systemctl restart containerd
export VERSION=1.20:1.20.0
export OS=CentOS_7
sudo curl -L -o /etc/yum.repos.d/devel:kubic:libcontainers:stable.repo https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/$OS/devel:kubic:libcontainers:stable.repo
sudo curl -L -o /etc/yum.repos.d/devel:kubic:libcontainers:stable:cri-o:$VERSION.repo https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable:cri-o:$VERSION/$OS/devel:kubic:libcontainers:stable:cri-o:$VERSION.repo
sudo yum install cri-o -y
sudo systemctl daemon-reload
sudo systemctl enable crio --now
sudo mkdir -p /etc/crio/crio.conf.d
cat <<EOF | sudo tee /etc/crio/crio.conf.d/02-cgroup-manager.conf
[crio.runtime]
conmon_cgroup = "podsudo systemctl restart docker"
cgroup_manager = "cgroupfs"
EOF
sudo mkdir /etc/docker
cat <<EOF | sudo tee /etc/docker/daemon.json
{
"exec-opts": ["native.cgroupdriver=systemd"],
"log-driver": "json-file",
"log-opts": {
 "max-size": "100m"
},
"storage-driver": "overlay2"
}
EOF
sudo systemctl enable docker
sudo systemctl daemon-reload
sudo systemctl restart docker
```



